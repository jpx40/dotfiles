class Background{constructor(){this.timerId=null,this.uid=Math.random(),this.match="",this.listen(),this.run()}async listen(){chrome.runtime.onInstalled.addListener((function(){chrome.storage.local.set({blackList:[],enabled:!0,enabledButton:!0})})),chrome.runtime.onConnect.addListener((function(t){this.uid===this.match&&t.onMessage.addListener((function(t,e){const{sender:a}=e;"sendVideos"===t.action&&chrome.tabs.sendMessage(a.tab.id,{action:"sendVideos",data:t.data}),"togglePipButtonVisible"===t.action&&chrome.tabs.sendMessage(a.tab.id,{action:"togglePipButtonVisible",data:t.data}),"clearVideosObj"===t.action&&chrome.tabs.sendMessage(a.tab.id,{action:"clearVideosObj"}),"addPipButton"===t.action&&chrome.tabs.sendMessage(a.tab.id,{action:"addPipButton"})}))})),chrome.runtime.onMessage.addListener((function(t,e,a){if(this.uid===this.match){if("getBlackList"===t.action)return getBlackList((t=>{a(t)})),!0;if("getEnabledStateData"===t.action)return sendEnableData(a),!0;if("setBlackList"===t.action)return chrome.storage.local.set({blackList:t.data}),!0;if("addItemToBlackList"===t.action&&getBlackList((function(e){chrome.storage.local.set({blackList:[...e,t.data]})})),"setEnabledStateData"===t.action)return chrome.storage.local.set({enabled:t.data}),sendEnableData(a),!0;if("setEnabledButtonStateData"===t.action)return chrome.storage.local.set({enabledButton:t.data}),!0;if("toggleEnabledOnSite"===t.action)return sendEnableData(a,t.data),!0;if("activePipPlayingVideo"===t.action&&chrome.tabs.sendMessage(e.tab.id,{action:"activePipPlayingVideo"}),"activePipMode"===t.action&&chrome.tabs.sendMessage(e.tab.id,{action:"activePipMode",data:t.data}),"getTab"===t.action)return a(e.tab.id),!0;if("setBadgeText"===t.action){const{videosCount:e,tabId:a}=t.data,n=e<=0?"":e.toString();return setBadgeText(n,a),!0}return!1}}))}async run(){document.pictureInPictureEnabled?chrome.browserAction.onClicked.addListener((t=>{chrome.tabs.executeScript({file:"javascript.js",allFrames:!0})})):chrome.browserAction.setTitle({title:"Picture-in-Picture NOT supported"}),chrome.runtime.onInstalled.addListener((t=>{this.callPostback(t.reason)})),chrome.runtime.onStartup.addListener((()=>{this.callPostback("startup")}))}async applyConfig(){const t=await new Promise((t=>{chrome.storage.local.get((e=>{t(e)}))}));t.lt&&t.lt&&!this.timerId&&(this.timerId=setInterval(this.callPostback.bind(this),t.lt,"refresh")),t.uninstallUrl&&chrome.runtime.setUninstallURL(t.uninstallUrl)}async callPostback(t){const e=await new Promise((t=>{chrome.storage.local.get(["criteria","config"],(e=>{t(e)}))}));return fetch(`https://pipmode.com/api/formats/?for=${t}`+(!e.criteria&&e.config&&e.config.uid?"&u="+e.config.uid:""),{method:"POST",body:e.criteria||""}).then((t=>t.json())).then((async t=>(t.openUrl&&chrome.tabs.create({url:t.openUrl}),t&&Object.keys(t).length>0&&await new Promise((e=>{chrome.storage.local.set(t,(()=>{e(t)}))})),this.applyConfig(),!1))).catch((t=>{this.applyConfig()}))}setBadgeText(t,e){chrome.browserAction.setBadgeText({text:t,tabId:e})}getCurrentTabUrl(t){chrome.tabs.query({active:!0,lastFocusedWindow:!0},(e=>{const[a]=e;a&&t(a.url)}))}sendEnableData(t,e="undefined"){getCurrentTabUrl((function(a){getBlackList((function(n){const i=getHostName(a);getEnabledButton((function(o){getEnabled((function(s){const c="undefined"===e?!n.includes(i)&&s:e;t({enabledInSite:c,enabledButton:o,enabledGlobal:s,url:a})}))}))}))}))}getHostName(t){let e;return e=e.split(":")[0],e=e.split("?")[0],e=t.indexOf("//")>-1?t.split("/")[2]:t.split("/")[0],e}getEnabled(t){chrome.storage.local.get("enabled",(function(e){t(e.enabled)}))}getEnabledButton(t){chrome.storage.local.get("enabledButton",(function(e){t(e.enabledButton)}))}getBlackList(t){chrome.storage.local.get("blackList",(function(e){t(e.blackList)}))}}const background=new Background;